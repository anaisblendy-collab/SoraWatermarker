# === CELLULE 1 - CONFIGURATION DU WATERMARK (exÃ©cuter une fois) ===

!apt-get update -y
!apt-get install -y ffmpeg

from google.colab import files
import os
from PIL import Image, ImageDraw, ImageFont

print("ğŸ¨ CONFIGURATION DU WATERMARK ANIMÃ‰")

def create_default_watermark():
    """CrÃ©e un watermark SORA animÃ© par dÃ©faut (GIF)"""
    print("ğŸ”„ CrÃ©ation d'un GIF animÃ© SORA par dÃ©faut...")

    # CrÃ©er plusieurs frames pour l'animation
    frames = []
    for i in range(8):
        img = Image.new('RGBA', (200, 80), (0, 0, 0, 0))
        draw = ImageDraw.Draw(img)

        # Effet de pulsation
        size_pulse = 30 + (i % 4) * 5
        opacity_pulse = 120 + (i % 4) * 35

        draw.text((20, 20), "SORA",
                 fill=(255, 255, 255, opacity_pulse),
                 font=ImageFont.load_default())

        frames.append(img)

    # Sauvegarder en GIF animÃ©
    frames[0].save('watermark.gif',
                  save_all=True,
                  append_images=frames[1:],
                  duration=150,  # 150ms entre frames
                  loop=0,        # boucle infinie
                  transparency=0)

    print("âœ… Watermark GIF animÃ© 'watermark.gif' crÃ©Ã©!")
    return "watermark.gif"

def upload_custom_watermark():
    """Upload un watermark animÃ© (GIF/MP4) ou image"""
    print("ğŸ“¤ Upload ton watermark animÃ©:")
    print("   â€¢ ğŸ¬ GIF animÃ© (recommandÃ©)")
    print("   â€¢ ğŸ¥ VidÃ©o MP4/MOV")
    print("   â€¢ ğŸ–¼ï¸ Image PNG/JPG")
    print("")
    print("ğŸ‘‰ Clique sur 'Choose Files' pour sÃ©lectionner ton fichier")

    uploaded = files.upload()

    if uploaded:
        custom_filename = list(uploaded.keys())[0]

        # Garder l'extension originale
        file_extension = os.path.splitext(custom_filename)[1].lower()
        new_filename = f"watermark{file_extension}"

        os.rename(custom_filename, new_filename)
        print(f"âœ… Watermark sauvegardÃ©: {new_filename}")

        # VÃ©rifier le type de fichier
        if file_extension in ['.gif', '.mp4', '.mov', '.avi']:
            print("ğŸ¬ Watermark animÃ© dÃ©tectÃ© - L'animation sera prÃ©servÃ©e!")
        else:
            print("ğŸ–¼ï¸ Image statique dÃ©tectÃ©")

        return new_filename
    else:
        print("âŒ Aucun fichier uploadÃ©, utilisation du watermark par dÃ©faut")
        return create_default_watermark()

# ==========================================
# ğŸš€ EXÃ‰CUTION PRINCIPALE
# ==========================================
print("=" * 50)
print("ğŸ”˜ CHOIX DU WATERMARK:")
print("1. âœ… Utiliser le watermark SORA animÃ© (GIF par dÃ©faut)")
print("2. ğŸ“¤ Uploader mon propre GIF/vidÃ©o/image")
print("")

# Choix automatique pour Colab (pas d'input())
print("ğŸ‘‰ SÃ©lection automatique: Option 2 (Upload)")
watermark_filename_global = upload_custom_watermark()

print("=" * 50)
print(f"ğŸ¯ Fichier watermark sÃ©lectionnÃ©: {watermark_filename_global}")
print("âœ… Configuration terminÃ©e! Tu peux maintenant traiter des vidÃ©os.")

# === CELLULE 2 - VERSION 1 : STABLE ET PRÃ‰VISIBLE ===

from google.colab import files
import os
import time

def process_video_with_watermark(watermark_filename):
    print("ğŸ“¤ Upload une nouvelle vidÃ©o Ã  traiter")
    print("ğŸ‘‰ Clique sur 'Choose Files' pour sÃ©lectionner ta vidÃ©o")

    uploaded_video = files.upload()

    if not uploaded_video:
        print("âŒ Aucune vidÃ©o uploadÃ©e")
        return

    video_filename = list(uploaded_video.keys())[0]
    quoted_video_filename = f'"{video_filename}"'
    output_filename = f"output_{int(time.time())}.mp4"

    print(f"ğŸ¥ Traitement de: {video_filename}")
    print("â³ Application du filigrane (positions coins + 1.8s visible)...") # Updated description

    quoted_watermark_filename = f'"{watermark_filename}"'

    # POSITIONS AUX COINS + DURÃ‰E 1.8s PAR POSITION
    # Corrected x and y expressions using nested if statements
    !ffmpeg -i {quoted_video_filename} -i {quoted_watermark_filename} \
    -filter_complex "\
    [1:v]scale=120:-1,format=rgba,loop=-1:size=300[wm_loop]; \
    [0:v][wm_loop]overlay=\
x='if(lt(mod(t,6),2), 30, if(lt(mod(t,6),4), main_w-overlay_w-30, 30))':\
y='if(lt(mod(t,6),2), 30, if(lt(mod(t,6),4), main_h*0.4, main_h-overlay_h-30))':\
enable='between(mod(t,6),0.1,1.9)+between(mod(t,6),2.1,3.9)+between(mod(t,6),4.1,5.9)':\
shortest=1" \
    -c:a copy "{output_filename}" -y

    if os.path.exists(output_filename):
        files.download(output_filename)
        print(f"âœ… SUCCÃˆS! {output_filename} tÃ©lÃ©chargÃ©")
        print("ğŸ¯ Positions COINS :")
        print("   â€¢ A : Haut-gauche (30, 30)")
        print("   â€¢ B : Haut-droit (W-iw-30, H*0.4)") # Updated description
        print("   â€¢ C : Bas-gauche (30, H-ih-30)") # Using H-ih-30 for description consistency with user
        print("ğŸ’« Visible : 1.8s par position (fondus 0.1s)")
        print("â±ï¸  Cycle : 6 secondes")

        os.remove(video_filename)
        print("ğŸ§¹ Fichier temporaire nettoyÃ©")
    else:
        print("âŒ Ã‰chec du traitement")

try:
    process_video_with_watermark(watermark_filename_global)
except NameError:
    print("âŒ Erreur: Veuillez exÃ©cuter la premiÃ¨re cellule pour configurer le watermark avant de traiter la vidÃ©o.")
